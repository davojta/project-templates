#!/usr/bin/env sh
. "$(dirname "$0")/_/husky.sh"

echo "üîç Running pre-commit checks..."

# Function to check if we're in a template directory
is_template_dir() {
    # Check if we're in a directory that looks like a template
    local current_dir=$(basename "$PWD")

    # Template directories typically have README.md and one of the common project files
    if [ -f "README.md" ]; then
        if [ -f "package.json" ] || [ -f "requirements.txt" ] || [ -f "go.mod" ] || [ -f "Cargo.toml" ] || [ -f "pyproject.toml" ] || [ -f "CMakeLists.txt" ] || [ -f "Makefile" ]; then
            return 0  # This is a template directory
        fi
    fi

    return 1  # Not a template directory
}

# Function to run checks for a specific template directory
check_template() {
    local template_dir="$1"
    echo "üìÅ Checking template: $template_dir"

    # Check if template has README.md
    if [ ! -f "$template_dir/README.md" ]; then
        echo "‚ùå Template '$template_dir' missing README.md"
        return 1
    fi

    # Check if README has minimal required sections
    local readme="$template_dir/README.md"
    if ! grep -q -i "## [Ii]nstallation\|## [Ss]etup\|## [Uu]sage\|## [Qq]uick [Ss]tart" "$readme"; then
        echo "‚ö†Ô∏è  Template '$template_dir' README should include setup/installation/usage sections"
    fi

    echo "‚úÖ Template '$template_dir' documentation looks good"
    return 0
}

# Check if we're committing from root repository
if [ "$PWD" = "$(git rev-parse --show-toplevel)" ]; then
    echo "üè† Root repository commit detected..."

    # Find all template directories (directories with README.md and package files)
    failed_templates=()

    for dir in */; do
        if [ -d "$dir" ] && [ -f "$dir/README.md" ]; then
            if [ -f "$dir/package.json" ] || [ -f "$dir/requirements.txt" ] || [ -f "$dir/go.mod" ] || [ -f "$dir/Cargo.toml" ] || [ -f "$dir/pyproject.toml" ] || [ -f "$dir/CMakeLists.txt" ] || [ -f "$dir/Makefile" ]; then
                if ! check_template "$dir"; then
                    failed_templates+=("$dir")
                fi
            fi
        fi
    done

    # If any template checks failed, exit with error
    if [ ${#failed_templates[@]} -gt 0 ]; then
        echo "‚ùå Template validation failed for: ${failed_templates[*]}"
        echo "Please fix the above issues before committing"
        exit 1
    fi

    # Check changed templates to ensure they still work
    echo "üîß Testing changed templates..."
    changed_dirs=$(git diff --cached --name-only | xargs dirname | sort -u | grep -v '^\.$')

    for dir in $changed_dirs; do
        if [ -d "$dir" ]; then
            cd "$dir"
            if is_template_dir; then
                # Run tests based on the project type
                if [ -f "package.json" ] && command -v npm >/dev/null 2>&1; then
                    if npm test >/dev/null 2>&1; then
                        echo "‚úÖ $dir (Node.js) tests passed"
                    fi
                elif [ -f "requirements.txt" ] || [ -f "pyproject.toml" ] && command -v python >/dev/null 2>&1; then
                    if python -m pytest >/dev/null 2>&1; then
                        echo "‚úÖ $dir (Python) tests passed"
                    fi
                elif [ -f "go.mod" ] && command -v go >/dev/null 2>&1; then
                    if go test ./... >/dev/null 2>&1; then
                        echo "‚úÖ $dir (Go) tests passed"
                    fi
                elif [ -f "Cargo.toml" ] && command -v cargo >/dev/null 2>&1; then
                    if cargo test >/dev/null 2>&1; then
                        echo "‚úÖ $dir (Rust) tests passed"
                    fi
                fi
            fi
            cd ..
        fi
    done
else
    echo "üìù Committing within a template directory..."

    # If committing within a template directory, validate that template
    if is_template_dir; then
        current_template=$(basename "$PWD")
        if ! check_template "."; then
            echo "‚ùå Template validation failed for '$current_template'"
            exit 1
        fi
    fi
fi

# Prevent committing large files
echo "üìè Checking file sizes..."
large_files=$(find . -type f -not -path "./.git/*" -not -path "./node_modules/*" -not -name "*.lock" -size +10M)
if [ -n "$large_files" ]; then
    echo "‚ùå Large files detected:"
    echo "$large_files"
    echo "Please remove or reduce file sizes before committing"
    exit 1
fi

# Check for common issues in project templates
echo "üîç Scanning for common issues..."

# Check for hardcoded secrets
if grep -r -i "password\|secret\|key\|token" . --include="*.js" --include="*.ts" --include="*.json" --include="*.md" --exclude-dir=node_modules --exclude-dir=.git | grep -v "password.*example\|secret.*example\|your.*key"; then
    echo "‚ö†Ô∏è  Warning: Possible hardcoded secrets detected. Please review before committing."
fi

# Check for TODO/FIXME comments
todo_count=$(grep -r "TODO\|FIXME" . --include="*.js" --include="*.ts" --include="*.py" --include="*.go" --exclude-dir=node_modules --exclude-dir=.git | wc -l)
if [ "$todo_count" -gt 0 ]; then
    echo "üìù Found $todo_count TODO/FIXME comments"
fi

echo "‚úÖ Pre-commit checks completed!"