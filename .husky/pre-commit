#!/usr/bin/env sh
. "$(dirname "$0")/_/husky.sh"

echo "ğŸ” Running pre-commit checks..."

# Check if we're in a template directory
if [ -f "package.json" ] && grep -q '"name": ".*template' package.json; then
    echo "ğŸ“¦ Detected template project, running template-specific checks..."

    # Check if template has required files
    required_files=("README.md" "package.json")
    missing_files=()

    for file in "${required_files[@]}"; do
        if [ ! -f "$file" ]; then
            missing_files+=("$file")
        fi
    done

    if [ ${#missing_files[@]} -gt 0 ]; then
        echo "âŒ Missing required files: ${missing_files[*]}"
        echo "Template projects must include: ${required_files[*]}"
        exit 1
    fi

    # Run tests if they exist
    if npm run test 2>/dev/null; then
        echo "âœ… Tests passed"
    elif [ $? -eq 1 ]; then
        echo "âŒ Tests failed"
        exit 1
    fi
else
    echo "ğŸ  Root repository checks..."

    # For root repository, check if we can build templates
    if [ -d "nodejs-ts-cli" ]; then
        echo "ğŸ”§ Testing nodejs-ts-cli template..."
        cd nodejs-ts-cli
        if npm run build; then
            echo "âœ… nodejs-ts-cli template builds successfully"
        else
            echo "âŒ nodejs-ts-cli template build failed"
            exit 1
        fi
        cd ..
    fi
fi

# Prevent committing large files
echo "ğŸ“ Checking file sizes..."
large_files=$(find . -type f -not -path "./.git/*" -not -path "./node_modules/*" -not -name "*.lock" -size +10M)
if [ -n "$large_files" ]; then
    echo "âŒ Large files detected:"
    echo "$large_files"
    echo "Please remove or reduce file sizes before committing"
    exit 1
fi

# Check for common issues in project templates
echo "ğŸ” Scanning for common issues..."

# Check for hardcoded secrets
if grep -r -i "password\|secret\|key\|token" . --include="*.js" --include="*.ts" --include="*.json" --include="*.md" --exclude-dir=node_modules --exclude-dir=.git | grep -v "password.*example\|secret.*example\|your.*key"; then
    echo "âš ï¸  Warning: Possible hardcoded secrets detected. Please review before committing."
fi

# Check for TODO/FIXME comments
todo_count=$(grep -r "TODO\|FIXME" . --include="*.js" --include="*.ts" --include="*.py" --include="*.go" --exclude-dir=node_modules --exclude-dir=.git | wc -l)
if [ "$todo_count" -gt 0 ]; then
    echo "ğŸ“ Found $todo_count TODO/FIXME comments"
fi

echo "âœ… Pre-commit checks completed!"